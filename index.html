<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mini-Speedtest Android</title>
<style>
body { font-family: monospace; background:#0e0e0e; color:#d0ffd0; padding:20px; }
h1 { color:#00ffaa; }
button { background:#00cc88; border:none; padding:10px 20px; font-size:16px; border-radius:8px; cursor:pointer; }
#results { margin-top:20px; background:#1c1c1c; padding:15px; border-radius:10px; width:fit-content; }
.value { color:#fff; font-weight:bold; }
</style>
</head>
<body>
<h1>Mini-Speedtest (Android)</h1>
<button id="btnStart">Test starten</button>
<div id="results">
<p>Status: <span id="status" class="value">bereit</span></p>
<p>IP: <span id="ip" class="value">–</span></p>
<p>Provider: <span id="isp" class="value">–</span></p>
<p>Download: <span id="dl" class="value">–</span></p>
<p>Upload: <span id="ul" class="value">–</span></p>
<p>Geschätzter Tarif: <span id="plan" class="value">–</span></p>
</div>

<script>
async function getIPInfo() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    return { ip: data.ip, isp: data.org || data.isp || 'unbekannt' };
  } catch {
    return { ip: 'Fehler', isp: 'Fehler' };
  }
}

async function tryDownload(url) {
  const start = performance.now();
  const res = await fetch(url, { cache:'no-store' });
  const blob = await res.blob();
  const end = performance.now();
  const time = (end - start) / 1000;
  const mbps = (blob.size * 8) / (1024*1024) / time;
  return mbps.toFixed(2);
}

async function downloadTest() {
  // Dateien, die du vorher ins Repository hochgeladen hast
  const urls = [
    '1MB.bin',
    '5MB.bin'
  ];
  for (const u of urls) {
    try {
      return await tryDownload(u);
    } catch(e) {
      console.warn('Download fehlgeschlagen:', u, e);
    }
  }
  throw new Error('Alle Download-Tests fehlgeschlagen');
}

function guessPlan(dl) {
  if(dl > 800) return '≈ 1 Gbit/s (Glasfaser)';
  if(dl > 300) return '≈ 250–500 Mbit/s';
  if(dl > 90) return '≈ 100–250 Mbit/s';
  if(dl > 25) return '≈ 50–100 Mbit/s';
  if(dl > 10) return '≈ 16–50 Mbit/s';
  return 'Langsam / Mobilnetz';
}

document.getElementById('btnStart').addEventListener('click', async () => {
  const g = id => document.getElementById(id);
  g('status').textContent = 'Starte Test...';
  g('dl').textContent = g('ul').textContent = g('plan').textContent = '–';

  const info = await getIPInfo();
  g('ip').textContent = info.ip;
  g('isp').textContent = info.isp;

  try {
    g('status').textContent = 'Download wird gemessen...';
    const dl = await downloadTest();
    g('dl').textContent = dl + ' Mbit/s';

    // Upload kann hier nicht korrekt getestet werden ohne eigenen Server
    g('ul').textContent = '–';

    g('plan').textContent = guessPlan(Number(dl));
    g('status').textContent = 'Fertig ✅';
  } catch(e) {
    g('status').textContent = 'Fehler beim Test ❌';
    console.error(e);
  }
});
</script>
</body>
</html>
